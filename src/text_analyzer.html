<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>TextovÃ½ analyzÃ¡tor â€“ MVP + CSV & File</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./css/style.css">
  <style>
    /* LokÃ¡lnÃ­ drobnosti */
    .mini { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:10px }
    .stat { background:#fff; border:1px solid #eee; border-radius:10px; padding:10px }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #eee; text-align:left }
    .bar { height: 8px; border-radius:4px; background: linear-gradient(90deg, #3b82f6 var(--p,0%), #e5e7eb var(--p,0%)); }
    .muted { color:#666; font-size:12px }
    .row { display:grid; grid-template-columns: 2fr 1fr; gap:16px }
    @media (max-width: 900px){ .row{ grid-template-columns: 1fr } }

    /* Drop zÃ³na pro soubory */
    .dropzone {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      background: #f8fafc;
      transition: background .15s, border-color .15s;
    }
    .dropzone.dragover {
      background: #eef2ff;
      border-color: #93c5fd;
    }

    /* Panel exportÅ¯ */
    .exports { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px }
    .btn { border:1px solid #dadada; background:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-size:14px; box-shadow:0 2px 6px rgba(0,0,0,.05) }
    .btn:hover { background:#f1f1f1 }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>ğŸ“ TextovÃ½ analyzÃ¡tor</h1>
      <div class="muted">PoÄÃ­tÃ¡ zÃ¡kladnÃ­ metriky, frekvence pÃ­smen a Ï‡Â² proti CZ/EN referenci. NovÄ›: nahrÃ¡vÃ¡nÃ­ souborÅ¯ a exporty do CSV. VÅ¡e bÄ›Å¾Ã­ lokÃ¡lnÄ› v prohlÃ­Å¾eÄi.</div>
    </div>

    <div class="row">
      <div class="card">
        <h3>Vstup</h3>

        <div class="mini" style="margin-bottom:10px">
          <div class="stat">
            <label for="file">NahrÃ¡t soubor (.txt, .md, .csv)</label>
            <input id="file" type="file" accept=".txt,.md,.csv, text/plain, text/markdown, text/csv">
            <div class="muted">NaÄte se UTF-8 a vloÅ¾Ã­ do pole nÃ­Å¾e.</div>
          </div>
          <div class="stat">
            <div class="dropzone" id="dropzone">PÅ™etÃ¡hni soubor sem nebo pouÅ¾ij â€NahrÃ¡t souborâ€œ</div>
            <div class="muted">VelkÃ© soubory chvÃ­li trvajÃ­ â€“ po naÄtenÃ­ probÄ›hne analÃ½za automaticky.</div>
          </div>
        </div>

  <textarea id="text" class="form-control" rows="10" placeholder="VloÅ¾ nebo napiÅ¡ textâ€¦">Ahoj svÄ›te! Toto je krÃ¡tkÃ½ ukÃ¡zkovÃ½ text. CH je v ÄeÅ¡tinÄ› digraf.</textarea>

        <div class="mini" style="margin-top:10px">
          <label class="stat"><input type="checkbox" id="lower" checked> pÅ™evÃ©st na malÃ¡ pÃ­smena</label>
          <label class="stat"><input type="checkbox" id="stripDia" checked> odstranit diakritiku</label>
          <label class="stat"><input type="checkbox" id="treatCH" checked> â€CHâ€œ jako jedno pÃ­smeno</label>
          <label class="stat"><input type="checkbox" id="inclNums"> poÄÃ­tat slova vÄ. ÄÃ­sel</label>
        </div>

        <div class="mini" style="margin-top:10px">
          <label class="stat">Ï‡Â² reference:
            <select id="refLang">
              <option value="cz" selected>ÄŒeÅ¡tina (Aâ€“Z + CH)</option>
              <option value="en">AngliÄtina (Aâ€“Z)</option>
            </select>
          </label>
          <button id="analyze" class="stat">Analyzovat</button>
          <span class="stat">Ï‡Â²: <b id="chiOut">â€“</b></span>
        </div>
      </div>

      <div class="card">
        <h3>PÅ™ehled</h3>
        <div class="mini">
          <div class="stat">Znaky (vÄ. mezer): <b id="charsAll">0</b></div>
          <div class="stat">Znaky (bez mezer): <b id="charsNo">0</b></div>
          <div class="stat">Slova: <b id="words">0</b></div>
          <div class="stat">UnikÃ¡tnÃ­ slova: <b id="uniq">0</b></div>
          <div class="stat">TTR: <b id="ttr">0</b></div>
          <div class="stat">Å˜Ã¡dky: <b id="lines">0</b></div>
          <div class="stat">Odstavce: <b id="pars">0</b></div>
          <div class="stat">PrÅ¯m. dÃ©lka slova: <b id="avgLen">0</b></div>
        </div>

        <h3 style="margin-top:16px">Exporty (CSV)</h3>
        <div class="exports">
          <button class="btn" id="csvMetrics">Exportovat metriky (CSV)</button>
          <button class="btn" id="csvLetters">Exportovat frekvence pÃ­smen (CSV)</button>
          <button class="btn" id="csvWords">Exportovat frekvence slov (CSV)</button>
        </div>
        <div class="muted" style="margin-top:6px">Frekvence slov jsou case-insensitive a respektujÃ­ volby normalizace vÃ½Å¡e.</div>
      </div>
    </div>

    <div class="card">
      <h3>Frekvence pÃ­smen</h3>
      <div class="muted">Abeceda se Å™Ã­dÃ­ volbou â€CH jako pÃ­smenoâ€œ. U reference EN se â€CHâ€œ pro Ï‡Â² ignoruje.</div>
      <table>
        <thead><tr><th>PÃ­smeno</th><th>PoÄet</th><th>%</th><th>Viz</th><th class="muted">OÄek. %</th><th class="muted">Î” (obsâˆ’oÄ)</th></tr></thead>
        <tbody id="freqBody"></tbody>
      </table>
    </div>

    <div class="card" id="topDevCard" style="display:none">
      <h3>TOP odchylky (Ï‡Â²)</h3>
      <div class="muted">PÃ­smena s nejvÄ›tÅ¡Ã­ odchylkou od zvolenÃ© reference.</div>
      <table>
        <thead><tr><th>PÃ­smeno</th><th>Obs. %</th><th>OÄek. %</th><th>|Î”|</th></tr></thead>
        <tbody id="devBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    // --- Reference frekvence v % ---
    const EN_FREQ = {A:8.167,B:1.492,C:2.782,D:4.253,E:12.702,F:2.228,G:2.015,H:6.094,I:6.966,J:0.153,K:0.772,L:4.025,M:2.406,N:6.749,O:7.507,P:1.929,Q:0.095,R:5.987,S:6.327,T:9.056,U:2.758,V:0.978,W:2.360,X:0.150,Y:1.974,Z:0.074};
    // CZ zjednoduÅ¡enÃ© (bez diakritiky), vÄetnÄ› CH
    const CZ_FREQ = {A:8.6,B:1.7,C:3.0,CH:0.9,D:3.6,E:9.8,F:0.3,G:0.3,H:1.5,I:7.5,J:2.2,K:3.6,L:3.8,M:3.4,N:6.7,O:8.6,P:3.1,Q:0.0,R:4.8,S:4.9,T:5.7,U:3.6,V:4.5,W:0.0,X:0.0,Y:1.7,Z:2.1};

    // --- Normalizace textu ---
    function stripDiacritics(s) {
      return s.normalize('NFD').replace(/\p{M}/gu,'').replace(/Å¯/g,'u').replace(/áº/g,'SS').replace(/ÃŸ/g,'ss');
    }
    function normalizeText(raw, {lower, stripDia}) {
      let t = raw;
      if (stripDia) t = stripDiacritics(t);
      if (lower) t = t.toLowerCase();
      return t;
    }

    // --- Tokenizace slov ---
    function tokenizeWords(t, includeNumbers=false) {
      const re = includeNumbers ? /[\p{L}\p{N}]+/gu : /[\p{L}]+/gu;
      return t.match(re) || [];
    }

    // --- PÃ­smena / abeceda (Aâ€“Z, volitelnÄ› CH) ---
    function lettersStream(t, treatCH) {
      const up = t.toUpperCase();
      const out = [];
      for (let i=0;i<up.length;i++){
        const c = up[i];
        const code = c.codePointAt(0);
        if (treatCH && c==='C' && i+1<up.length && up[i+1]==='H'){ out.push('CH'); i++; continue; }
        if (code>=65 && code<=90){ out.push(c); }
      }
      return out;
    }
    function alphabet(treatCH){
      const base = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
      return treatCH ? ['A','B','C','CH','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'] : base;
    }

    function letterFrequencies(t, treatCH){
      const alpha = alphabet(treatCH);
      const counts = Object.fromEntries(alpha.map(a=>[a,0]));
      const letters = lettersStream(t, treatCH);
      let total = 0;
      for (const L of letters){ if (counts[L]!==undefined){ counts[L]++; total++; } }
      const freq = {};
      for (const k of alpha){
        const pct = total? (counts[k]/total*100) : 0;
        freq[k] = {count: counts[k], pct};
      }
      return {freq, total, alpha};
    }

    function chiSquare(freqMap, totalLetters, ref) {
      let chi = 0;
      for (const [k, v] of Object.entries(freqMap)) {
        if (!(k in ref)) continue;
        const expected = ref[k]/100 * totalLetters;
        if (expected>0){
          const diff = v.count - expected;
          chi += (diff*diff)/expected;
        }
      }
      return chi;
    }

    // --- Frekvence slov (mapa) ---
    function wordFrequency(wordsArr) {
      const m = new Map();
      for (const w of wordsArr){
        const key = w.toLowerCase();
        m.set(key, (m.get(key)||0)+1);
      }
      return m; // Map<slovo, count>
    }

    // --- CSV helpers ---
    function csvEscape(value){
      const v = String(value ?? '');
      return /[",;\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v;
    }
    function downloadCSV(filename, rows){
      const csv = rows.map(r => r.map(csvEscape).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    // --- Stav poslednÃ­ analÃ½zy (pro exporty) ---
    let last = {
      opts: null,
      raw: '',
      norm: '',
      metrics: null,
      letters: null,
      refName: '',
      ref: null,
      wordsArr: [],
      wordFreq: null
    };

    function analyze() {
      const opts = {
        lower: $('lower').checked,
        stripDia: $('stripDia').checked,
        treatCH: $('treatCH').checked,
        includeNumbers: $('inclNums').checked
      };
      const refLang = $('refLang').value;
      const ref = (refLang==='cz') ? CZ_FREQ : EN_FREQ;
      const refName = (refLang==='cz') ? 'CZ' : 'EN';

      const raw = $('text').value ?? '';
      const norm = normalizeText(raw, opts);

      // metriky
      const charsAll = norm.length;
      const charsNo = norm.replace(/\s+/g,'').length;
      const lines = norm ? norm.split(/\n/).length : 0;
      const pars = norm ? norm.split(/\n\s*\n/).filter(x=>x.trim().length).length : 0;
      const words = tokenizeWords(norm, opts.includeNumbers);
      const wordCount = words.length;
      const uniq = new Set(words.map(w=>w.toLowerCase())).size;
      const ttr = wordCount ? (uniq/wordCount) : 0;
      const avgLen = wordCount ? (words.join('').length/wordCount) : 0;

      $('charsAll').textContent = charsAll;
      $('charsNo').textContent  = charsNo;
      $('lines').textContent    = lines;
      $('pars').textContent     = pars;
      $('words').textContent    = wordCount;
      $('uniq').textContent     = uniq;
      $('ttr').textContent      = ttr.toFixed(3);
      $('avgLen').textContent   = avgLen.toFixed(2);

      // frekvence pÃ­smen
      const {freq, total, alpha} = letterFrequencies(norm, opts.treatCH);

      const chi = chiSquare(freq, total, ref);
      $('chiOut').textContent = total ? chi.toFixed(2) : 'â€“';

      // tabulka frekvencÃ­
      const tbody = $('freqBody'); tbody.innerHTML = '';
      const rows = alpha.map(k => {
        const f = freq[k] || {count:0,pct:0};
        const exp = (ref[k] ?? 0);
        const delta = f.pct - exp;
        return {k, ...f, exp, deltaAbs: Math.abs(delta), delta};
      });
      for (const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${r.k}</b></td>
          <td class="mono">${r.count}</td>
          <td class="mono">${r.pct.toFixed(2)}</td>
          <td><div class="bar" style="--p:${r.pct}%"></div></td>
          <td class="mono muted">${r.exp ? r.exp.toFixed(2) : 'â€”'}</td>
          <td class="mono muted">${(r.exp ? r.delta.toFixed(2) : 'â€”')}</td>
        `;
        tbody.appendChild(tr);
      }

      // TOP odchylky
      const dev = rows.filter(r => r.k in ref).sort((a,b)=>b.deltaAbs - a.deltaAbs).slice(0,8);
      const devBody = $('devBody');
      if (dev.length){
        $('topDevCard').style.display = '';
        devBody.innerHTML = dev.map(r => `
          <tr>
            <td><b>${r.k}</b></td>
            <td class="mono">${r.pct.toFixed(2)}</td>
            <td class="mono">${r.exp.toFixed(2)}</td>
            <td class="mono">${r.deltaAbs.toFixed(2)}</td>
          </tr>
        `).join('');
      } else {
        $('topDevCard').style.display = 'none';
      }

      // uloÅ¾ stav pro exporty
      last = {
        opts, raw, norm,
        metrics: {charsAll, charsNo, lines, pars, wordCount, uniq, ttr, avgLen, chi, lettersTotal: total, refName},
        letters: {rows, alpha, total},
        refName, ref,
        wordsArr: words,
        wordFreq: wordFrequency(words)
      };
    }

    // --- CSV exporty ---
    function exportMetricsCSV(){
      const m = last.metrics;
      if (!m){ return; }
      const rows = [
        ['metric','value'],
        ['chars_all', m.charsAll],
        ['chars_no_spaces', m.charsNo],
        ['lines', m.lines],
        ['paragraphs', m.pars],
        ['words', m.wordCount],
        ['unique_words', m.uniq],
        ['ttr', m.ttr],
        ['avg_word_length', m.avgLen],
        ['letters_total', m.lettersTotal],
        ['chi_square', m.chi],
        ['reference', m.refName],
        ['options_lower', last.opts.lower],
        ['options_strip_diacritics', last.opts.stripDia],
        ['options_treat_CH', last.opts.treatCH],
        ['options_include_numbers', last.opts.includeNumbers]
      ];
      downloadCSV('metrics.csv', rows);
    }

    function exportLettersCSV(){
      if (!last.letters){ return; }
      const rows = [['letter','count','percent','expected_percent','delta_percent']];
      for (const r of last.letters.rows){
        rows.push([r.k, r.count, r.pct.toFixed(6), (r.exp||0).toFixed(6), (r.delta||0).toFixed(6)]);
      }
      downloadCSV('letter_frequencies.csv', rows);
    }

    function exportWordsCSV(){
      if (!last.wordFreq){ return; }
      // Map -> array, seÅ™adit sestupnÄ› podle poÄtu
      const arr = Array.from(last.wordFreq.entries()).sort((a,b)=>b[1]-a[1]);
      const rows = [['word','count']];
      for (const [w, c] of arr){
        rows.push([w, c]);
      }
      downloadCSV('word_frequencies.csv', rows);
    }

    // --- NahrÃ¡vÃ¡nÃ­ souborÅ¯ ---
    function readFileToTextarea(file){
      if (!file) return;
      const maxPreview = 15000000; // 15 MB â€“ ochrana pÅ™ed extrÃ©mnÃ­mi soubory
      if (file.size > maxPreview) {
        if (!confirm(`Soubor mÃ¡ ${(file.size/1024/1024).toFixed(1)} MB. NaÄÃ­st? MÅ¯Å¾e to chvÃ­li trvat.`)) return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        $('text').value = e.target.result || '';
        analyze();
      };
      reader.onerror = () => alert('Soubor se nepodaÅ™ilo naÄÃ­st.');
      reader.readAsText(file, 'utf-8');
    }

    $('file').addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0];
      readFileToTextarea(f);
      e.target.value = ''; // umoÅ¾nÃ­ nahrÃ¡t stejnÃ½ soubor znovu
    });

    const dz = $('dropzone');
    dz.addEventListener('dragover', (e)=>{ e.preventDefault(); dz.classList.add('dragover'); });
    dz.addEventListener('dragleave', ()=> dz.classList.remove('dragover'));
    dz.addEventListener('drop', (e)=>{
      e.preventDefault();
      dz.classList.remove('dragover');
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      readFileToTextarea(f);
    });

    // DrÃ¡ty UI
    $('analyze').addEventListener('click', analyze);
    let t=null;
    $('text').addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(analyze, 250); });
    ['lower','stripDia','treatCH','inclNums','refLang'].forEach(id=>{
      $(id).addEventListener('change', analyze);
    });

    // Exporty
    $('csvMetrics').addEventListener('click', exportMetricsCSV);
    $('csvLetters').addEventListener('click', exportLettersCSV);
    $('csvWords').addEventListener('click', exportWordsCSV);

    // Start
    analyze();
  </script>
</body>
</html>
