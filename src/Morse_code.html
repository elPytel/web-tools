<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>Text ⇄ Morse – převodník</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --pad: 14px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
           margin: 0; padding: 24px; background: #f7f7f8; color: #111; }
    .app { max-width: 900px; margin: 0 auto; display: grid; gap: 16px; }
    h1 { margin: 0 0 8px; font-size: 28px; }
    .card { background: #fff; border-radius: 16px; padding: var(--pad);
            box-shadow: 0 6px 20px rgba(0,0,0,.06); }
    textarea, input[type="text"] {
      box-sizing: border-box; /* include padding/border in width */
      width: 100%; max-width: 100%; min-height: 130px; font-size: 16px; line-height: 1.4;
      padding: 12px; border-radius: 10px; border: 1px solid #ddd; resize: vertical;
      background: #fafafa; overflow: auto;
      white-space: pre-wrap; /* wrap long lines, preserve line breaks */
      word-wrap: break-word;
      overflow-wrap: anywhere; /* allow breaking long Morse sequences */
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .controls > * { margin: 4px 0; }
    button {
      border: 1px solid #dadada; background: #fff; padding: 8px 12px;
      border-radius: 10px; cursor: pointer; font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,.05);
    }
    button:hover { background: #f1f1f1; }
    .pill { padding: 4px 10px; border-radius: 999px; font-size: 13px; background:#f0f3ff; border-color:#cfd8ff; }
    .grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
    .small { font-size: 12px; color: #555; }
    code { background: #f3f3f3; padding: 2px 6px; border-radius: 6px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #eee; text-align: left; }
    @media (max-width: 800px) { .row, .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Text ⇄ Morseův kód</h1>
      <div class="small">Podporuje ITU znakovou sadu, normalizuje českou diakritiku a má speciální zacházení s „<b>CH</b>“ → <code>----</code>.</div>
    </div>

    <div class="row">
      <div class="card">
        <h3>Text → Morse</h3>
  <textarea id="textInput" class="form-control" placeholder="Zadej běžný text (např. &quot;Ahoj světe!&quot;)"></textarea>
        <div class="controls">
          <button id="toMorseBtn">Převést na Morse</button>
          <button id="copyMorseBtn" class="pill">Kopírovat Morse</button>
          <button id="clearTextBtn">Vymazat</button>
        </div>
        <div class="controls">
          <label>Rychlost (WPM): <input type="number" id="wpm" value="18" min="5" max="60" style="width:80px"></label>
          <label>Frekvence (Hz): <input type="number" id="freq" value="650" min="200" max="1200" style="width:90px"></label>
          <button id="playBtn">▶︎ Přehrát Morse</button>
          <button id="stopBtn">⏹ Zastavit</button>
          <button id="downloadBtn">⬇︎ Stáhnout WAV</button>
        </div>
  <textarea id="morseOutput" class="form-control" placeholder="Zde bude Morseův kód…" readonly></textarea>
        <div class="small">Konvence: písmena oddělena mezerou, slova znakem <code>/</code>.</div>
      </div>

      <div class="card">
        <h3>Morse → Text</h3>
  <textarea id="morseInput" class="form-control" placeholder="Zadej Morse (např. &quot;.- .... --- .--- / ... ...- . - .&quot;)"></textarea>
        <div class="controls">
          <button id="toTextBtn">Převést na text</button>
          <button id="copyTextBtn" class="pill">Kopírovat text</button>
          <button id="clearMorseBtn">Vymazat</button>
        </div>
  <textarea id="textOutput" class="form-control" placeholder="Zde bude dešifrovaný text…" readonly></textarea>
        <div class="small">Oddělovače: mezera mezi písmeny, <code>/</code> mezi slovy. „<code>----</code>“ se dekóduje jako <b>CH</b>.</div>
      </div>
    </div>

    <div class="card">
      <h3>Legenda (zkrácený výběr ITU)</h3>
      <div class="grid">
        <div>
          <table>
            <thead><tr><th>Zn.</th><th>Morse</th></tr></thead>
            <tbody id="legendA"></tbody>
          </table>
        </div>
        <div>
          <table>
            <thead><tr><th>Zn.</th><th>Morse</th></tr></thead>
            <tbody id="legendB"></tbody>
          </table>
        </div>
      </div>
      <div class="small">Pozn.: česká diakritika se převádí na základní písmena. Digraf <b>CH</b> má tradiční kód <code>----</code>.</div>
    </div>
  </div>

  <script>
    // --- Normalizace češtiny (diakritika) ---
    function normalizeCzech(str) {
      return str
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // odstraní diakritiku
        .replace(/ů/g, 'u') // NFD někdy ponechá ů jako kombinaci, pro jistotu zvlášť
        .replace(/ẞ/g, 'SS') // pro úplnost
        .replace(/ß/g, 'ss');
    }

    // --- Morse tabulka ITU (písmena, čísla, základní interpunkce) ---
    const MORSE = {
      A: ".-",    B: "-...",  C: "-.-.",  D: "-..",   E: ".",
      F: "..-.",  G: "--.",   H: "....",  I: "..",    J: ".---",
      K: "-.-",   L: ".-..",  M: "--",    N: "-.",    O: "---",
      P: ".--.",  Q: "--.-",  R: ".-.",   S: "...",   T: "-",
      U: "..-",   V: "...-",  W: ".--",   X: "-..-",  Y: "-.--",
      Z: "--..",
      "CH": "----", // český digraf (tradičně používaný)
      0: "-----", 1: ".----", 2: "..---", 3: "...--", 4: "....-",
      5: ".....", 6: "-....", 7: "--...", 8: "---..", 9: "----.",
      ".": ".-.-.-", ",": "--..--", "?": "..--..", "'": ".----.",
      "!": "-.-.--", "/": "-..-.",  "(": "-.--.",  ")": "-.--.-",
      "&": ".-...",  ":": "---...", ";": "-.-.-.", "=": "-...-",
      "+": ".-.-.",  "-": "-....-", "_": "..--.-", "\"": ".-..-.",
      "$": "...-..-", "@": ".--.-."
    };

    // Reverzní mapa (včetně CH)
    const REVERSE = {};
    for (const [k, v] of Object.entries(MORSE)) REVERSE[v] = k;

    // --- Pomocné: tokenizace CH při převodu text→morse ---
    function splitWithCH(s) {
      const out = [];
      let i = 0;
      while (i < s.length) {
        if (i + 1 < s.length && s[i] === 'C' && s[i+1] === 'H') {
          out.push('CH'); i += 2;
        } else {
          out.push(s[i]); i++;
        }
      }
      return out;
    }

    // --- Text → Morse ---
    function textToMorse(input) {
      const norm = normalizeCzech(input).toUpperCase();
      const words = norm.split(/\s+/).filter(Boolean);
      const encodedWords = words.map(w => {
        const letters = splitWithCH(w);
        return letters.map(ch => {
          if (MORSE[ch]) return MORSE[ch];
          // pokud není v tabulce: zkusit písmeno (A-Z) či číslo – jinak zachovat jako ?
          if (/^[A-Z0-9]$/.test(ch)) return MORSE[ch] || '?';
          return MORSE[ch] || ''; // interpunkci už mapujeme výše
        }).filter(Boolean).join(' ');
      });
      return encodedWords.join(' / ');
    }

    // --- Morse → Text ---
    function morseToText(input) {
      // povolit více oddělovačů mezi slovy: "/" nebo " / "
      const words = input.trim().split(/\s*\/\s*/);
      const decodedWords = words.map(w => {
        const letters = w.trim().split(/\s+/).filter(Boolean);
        const chars = letters.map(code => {
          if (REVERSE[code]) return REVERSE[code];
          return '?';
        });
        // spojit a nahradit případ, kdy někdo psal "----" a očekává CH (to dělá REVERSE, ale pojistíme)
        return chars.join('');
      });
      return decodedWords.join(' ').replace(/\bCH\b/g, 'CH');
    }

    // --- Audio přehrávání Morse (WebAudio) ---
    let audioCtx = null;
    let stopFlag = false;

    function dotMsFromWPM(wpm) {
      // standard PARIS: jedna tečka = 1200 / WPM ms
      return 1200 / Math.max(1, wpm);
    }

    async function playMorse(morse, wpm=18, freq=650) {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      stopFlag = false;
      const unit = dotMsFromWPM(wpm); // ms
      const tone = (durMs) => new Promise(res => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start();
        // náběh/zklidnění pro příjemnější zvuk
        gain.gain.linearRampToValueAtTime(0.6, audioCtx.currentTime + 0.005);
        gain.gain.setValueAtTime(0.6, audioCtx.currentTime + (durMs/1000 - 0.01));
        gain.gain.linearRampToValueAtTime(0.001, audioCtx.currentTime + (durMs/1000));
        setTimeout(() => { osc.stop(); res(); }, durMs);
      });

      const sleep = (ms) => new Promise(res => setTimeout(res, ms));

      // pravidla: tečka = 1u, čárka = 3u, mezera mezi částmi znaku = 1u, mezi písmeny = 3u, mezi slovy = 7u
      for (let i = 0; i < morse.length && !stopFlag; i++) {
        const ch = morse[i];
        if (ch === '.') { await tone(unit); await sleep(unit); }
        else if (ch === '-') { await tone(3*unit); await sleep(unit); }
        else if (ch === ' ') { await sleep(2*unit); } // už předtím 1u padlo po posledním prvku znaku => dohromady 3u
        else if (ch === '/') { await sleep(6*unit); } // s předchozím 1u = 7u
      }
    }

    function stopAudio() { stopFlag = true; }

    // --- Render Morse to WAV blob ---
    function renderMorseToWav(morse, wpm=18, freq=650, sampleRate=44100) {
      const unitMs = dotMsFromWPM(wpm); // ms per unit
      const unitSamples = Math.round(sampleRate * unitMs / 1000);
      const twoPi = Math.PI * 2;

      // build sample array (Float32)
      const samples = [];

      const appendSilence = (samplesCount) => {
        for (let i = 0; i < samplesCount; i++) samples.push(0);
      };

      const appendTone = (samplesCount) => {
        // simple sine wave with short fade in/out
        const fadeSamples = Math.min( Math.round(sampleRate * 0.005), Math.floor(samplesCount/4) ); // ~5ms
        for (let i = 0; i < samplesCount; i++) {
          const t = i / sampleRate;
          const phase = (i / sampleRate) * freq * twoPi;
          let amp = Math.sin(phase);
          // envelope
          if (i < fadeSamples) amp *= (i / fadeSamples);
          else if (i > samplesCount - fadeSamples) amp *= ((samplesCount - i) / fadeSamples);
          // clamp
          samples.push(amp * 0.6);
        }
      };

      for (let i = 0; i < morse.length; i++) {
        const ch = morse[i];
        if (ch === '.') { appendTone(unitSamples); appendSilence(unitSamples); }
        else if (ch === '-') { appendTone(3*unitSamples); appendSilence(unitSamples); }
        else if (ch === ' ') { appendSilence(2*unitSamples); } // already 1u after element
        else if (ch === '/') { appendSilence(6*unitSamples); }
      }

      // convert to 16-bit PCM and WAV
      const numChannels = 1;
      const bufferLength = samples.length;
      const bytesPerSample = 2;
      const blockAlign = numChannels * bytesPerSample;
      const byteRate = sampleRate * blockAlign;
      const dataSize = bufferLength * bytesPerSample;
      const buffer = new ArrayBuffer(44 + dataSize);
      const view = new DataView(buffer);

      let offset = 0;
      function writeString(s) { for (let i=0;i<s.length;i++) view.setUint8(offset++, s.charCodeAt(i)); }
      function writeUint32(v) { view.setUint32(offset, v, true); offset += 4; }
      function writeUint16(v) { view.setUint16(offset, v, true); offset += 2; }

      writeString('RIFF');
      writeUint32(36 + dataSize);
      writeString('WAVE');
      writeString('fmt ');
      writeUint32(16); // PCM chunk size
      writeUint16(1); // PCM format
      writeUint16(numChannels);
      writeUint32(sampleRate);
      writeUint32(byteRate);
      writeUint16(blockAlign);
      writeUint16(16); // bits per sample
      writeString('data');
      writeUint32(dataSize);

      // write samples
      for (let i = 0; i < bufferLength; i++) {
        let s = samples[i];
        // clamp
        if (s > 1) s = 1; else if (s < -1) s = -1;
        view.setInt16(offset, Math.round(s * 32767), true);
        offset += 2;
      }

      return new Blob([view], { type: 'audio/wav' });
    }

    // --- Download WAV handler ---
    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.addEventListener('click', () => {
      const morse = morseOutput.value || textToMorse(textInput.value);
      if (!morse) return alert('Není nic k exportu. Nejprve vygenerujte Morse kód.');
      downloadBtn.disabled = true;
      try {
        const blob = renderMorseToWav(morse, Number(wpmEl.value||18), Number(freqEl.value||650));
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'morse.wav';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } finally {
        downloadBtn.disabled = false;
      }
    });

    // --- UI bindingy ---
    const textInput = document.getElementById('textInput');
    const morseOutput = document.getElementById('morseOutput');
    const morseInput = document.getElementById('morseInput');
    const textOutput = document.getElementById('textOutput');
    const toMorseBtn = document.getElementById('toMorseBtn');
    const toTextBtn = document.getElementById('toTextBtn');
    const copyMorseBtn = document.getElementById('copyMorseBtn');
    const copyTextBtn = document.getElementById('copyTextBtn');
    const clearTextBtn = document.getElementById('clearTextBtn');
    const clearMorseBtn = document.getElementById('clearMorseBtn');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const wpmEl = document.getElementById('wpm');
    const freqEl = document.getElementById('freq');

    toMorseBtn.addEventListener('click', () => {
      morseOutput.value = textToMorse(textInput.value);
    });
    toTextBtn.addEventListener('click', () => {
      textOutput.value = morseToText(morseInput.value);
    });
    copyMorseBtn.addEventListener('click', async () => {
      await navigator.clipboard.writeText(morseOutput.value || '');
    });
    copyTextBtn.addEventListener('click', async () => {
      await navigator.clipboard.writeText(textOutput.value || '');
    });
    clearTextBtn.addEventListener('click', () => { textInput.value = ''; morseOutput.value=''; });
    clearMorseBtn.addEventListener('click', () => { morseInput.value = ''; textOutput.value=''; });

    playBtn.addEventListener('click', async () => {
      const morse = morseOutput.value || textToMorse(textInput.value);
      if (!morse) return;
      stopFlag = false;
      playBtn.disabled = true; stopBtn.disabled = false;
      try { await playMorse(morse, Number(wpmEl.value||18), Number(freqEl.value||650)); }
      finally { playBtn.disabled = false; stopBtn.disabled = true; }
    });
    stopBtn.addEventListener('click', () => stopAudio());

    // Živý režim (volitelné – převod při psaní)
    textInput.addEventListener('input', () => { morseOutput.value = textToMorse(textInput.value); });
    morseInput.addEventListener('input', () => { textOutput.value = morseToText(morseInput.value); });

    // --- Legenda: rozdělíme na dvě tabulky pro přehlednost ---
    const entries = Object.entries(MORSE)
      .filter(([k, _]) => k.length === 1 || k === 'CH'); // zobrazíme i CH
    const half = Math.ceil(entries.length / 2);
    function fillLegend(tbodyId, arr) {
      const tbody = document.getElementById(tbodyId);
      tbody.innerHTML = arr.map(([k,v]) => `<tr><td><b>${k}</b></td><td><code>${v}</code></td></tr>`).join('');
    }
    fillLegend('legendA', entries.slice(0, half));
    fillLegend('legendB', entries.slice(half));
  </script>
</body>
</html>
